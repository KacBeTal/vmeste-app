<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–í–ú–µ—Å—Ç–µ üåä | OK.ru</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- OK SDK (–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –ü–†–ê–í–ò–õ–¨–ù–´–ô) -->
    <script src="https://api.ok.ru/js/fapi5.js"></script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- ====== –¢–í–û–ò –°–¢–ò–õ–ò (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ====== -->
    <!-- –Ø –ò–• –ù–ï –¢–†–û–ì–ê–õ -->
    <!-- ‚Üì‚Üì‚Üì -->
    <!-- (—Å—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, —Å–º. —Ç–≤–æ–π –∏—Å—Ö–æ–¥–Ω–∏–∫) -->
    <!-- ‚Üë‚Üë‚Üë -->

    <!-- ‚¨áÔ∏è –Ø –ù–ï –í–°–¢–ê–í–õ–Ø–Æ –°–¢–ò–õ–ò –ó–ê–ù–û–í–û –í –û–¢–í–ï–¢–ï,
         –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω–∏ –£ –¢–ï–ë–Ø –£–ñ–ï –ï–°–¢–¨ –∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å.
         –ü—Ä–æ—Å—Ç–æ –û–°–¢–ê–í–¨ –ò–• –ö–ê–ö –ë–´–õ–û -->
</head>
<body>

<div class="waves"></div>

<div id="loading" class="loading">
    <div class="loader"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –í–ú–µ—Å—Ç–µ‚Ä¶</p>
    <p id="loading-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OK.ru‚Ä¶</p>
</div>

<div id="app-container" class="app-container" style="display:none">
    <!-- –í–ï–°–¨ –¢–í–û–ô HTML –ò–ù–¢–ï–†–§–ï–ô–° ‚Äî –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô -->
</div>

<script>
/* ================== –ö–û–ù–§–ò–ì ================== */
const SUPABASE_URL = 'https://pyhatmplhbogwufatdga.supabase.co';
const SUPABASE_KEY = 'sb_publishable_rEZH-AdtzcBxBGeEA1hthQ_Ev3YtQ6d';

/* ================== STATE ================== */
let supabaseClient = null;
let currentUser = null;

/* ================== LOADER ================== */
function setLoader(text) {
    document.getElementById('loading-status').textContent = text;
    console.log('[LOADER]', text);
}

function showApp() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app-container').style.display = 'block';
}

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', () => {
    initApp();
});

async function initApp() {
    setLoader('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶');

    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ OK SDK
    if (typeof OK === 'undefined') {
        setLoader('–û—à–∏–±–∫–∞: OK SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return; // ‚ùå –ù–ò–ö–ê–ö–û–ì–û UI
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ OK
    const params = new URLSearchParams(location.search);
    if (params.get('vk_client') !== 'ok') {
        setLoader('–û—à–∏–±–∫–∞: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ OK.ru');
        return;
    }

    // 3. Supabase
    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OK
    setLoader('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OK.ru‚Ä¶');

    OK.init(() => {
        loadOKProfile();
    }, (err) => {
        console.error(err);
        setLoader('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OK');
    });
}

/* ================== OK PROFILE ================== */
function loadOKProfile() {
    setLoader('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è OK‚Ä¶');

    OK.api('users.getCurrentUser', {}, async (profile) => {
        if (!profile || profile.error_code) {
            console.error(profile);
            setLoader('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è OK');
            return; // ‚ùå –≤–µ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        }

        // ‚úÖ –¢–û–õ–¨–ö–û –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
        currentUser = {
            ok_id: profile.uid,
            first_name: profile.first_name,
            last_name: profile.last_name,
            full_name: profile.first_name + ' ' + profile.last_name,
            avatar: profile.pic_1,
            location: profile.location?.city || null
        };

        applyProfile();
        await saveProfile();
        showApp();
    });
}

/* ================== UI ================== */
function applyProfile() {
    document.getElementById('user-name').textContent = currentUser.full_name;
    document.getElementById('user-avatar').src = currentUser.avatar;
    document.getElementById('user-location').textContent =
        currentUser.location ? `üìç ${currentUser.location}` : 'üìç OK.ru';
}

/* ================== DATABASE ================== */
async function saveProfile() {
    await supabaseClient
        .from('profiles')
        .upsert({
            ok_id: currentUser.ok_id,
            full_name: currentUser.full_name,
            avatar_url: currentUser.avatar,
            location: currentUser.location,
            is_ok_user: true,
            is_online: true,
            last_seen: new Date().toISOString()
        }, { onConflict: 'ok_id' });
}
</script>

</body>
</html>
