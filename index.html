<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВМесте Mini App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .user-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-card img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #ee8208;
        }
        .avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ee8208 0%, #f6b044 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ee8208;
        }
        .user-card h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #ee8208;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
        }
        button:hover {
            background-color: #d67307;
        }
        .message-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        .debug-console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 600px;
            width: 100%;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="user-card">
    <div class="avatar-placeholder" id="avatarPlaceholder">OK</div>
    <img id="userAvatar" style="display: none;" alt="Avatar">
    <h2 id="userName">Загрузка...</h2>
</div>

<div class="message-box" id="messageBox">
    Добро пожаловать в приложение ВМесте!
</div>

<button id="randomMessageBtn">Случайное сообщение</button>
<button id="debugBtn" onclick="debugSDK()">Отладка SDK</button>

<div class="debug-console" id="debugConsole">
    Консоль отладки:
</div>

<script>
// ID вашего приложения OK
const OK_APP_ID = 512004483266;

// Функция для отладки в консоль
function debugLog(message) {
    const consoleDiv = document.getElementById('debugConsole');
    consoleDiv.innerHTML += '\n' + message;
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
    console.log(message);
}

// Функция для отладки SDK
function debugSDK() {
    debugLog('=== ОТЛАДКА SDK ===');
    debugLog('window.OK: ' + (window.OK ? 'есть' : 'нет'));
    debugLog('window.OKSDK: ' + (window.OKSDK ? 'есть' : 'нет'));
    debugLog('typeof OK: ' + typeof window.OK);
    debugLog('typeof OKSDK: ' + typeof window.OKSDK);
    
    if (window.OK) {
        debugLog('OK keys: ' + Object.keys(window.OK).join(', '));
        if (window.OK.Api) {
            debugLog('OK.Api: есть');
            debugLog('OK.Api.call: ' + (typeof window.OK.Api.call === 'function' ? 'функция' : 'нет'));
        }
    }
    
    if (window.OKSDK) {
        debugLog('OKSDK keys: ' + Object.keys(window.OKSDK).join(', '));
        debugLog('OKSDK.API: ' + (typeof window.OKSDK.API === 'function' ? 'функция' : 'нет'));
        debugLog('OKSDK.init: ' + (typeof window.OKSDK.init === 'function' ? 'функция' : 'нет'));
    }
    
    // Проверяем параметры
    const params = new URLSearchParams(window.location.search);
    debugLog('=== ПАРАМЕТЫ URL ===');
    for (const [key, value] of params) {
        debugLog(`${key}: ${value}`);
    }
}

// Функция для получения информации о пользователе через VK Bridge
async function getUserInfoViaVKBridge() {
    try {
        if (typeof vkBridge !== 'undefined') {
            debugLog('Попытка через VK Bridge...');
            const userInfo = await vkBridge.send('VKWebAppGetUserInfo', {});
            return {
                first_name: userInfo.user.first_name,
                last_name: userInfo.user.last_name,
                photo_200: userInfo.user.photo_200
            };
        }
    } catch (error) {
        debugLog('Ошибка VK Bridge: ' + error.message);
    }
    return null;
}

// Функция для получения информации о пользователе через FAPI
async function getUserInfoViaFAPI() {
    try {
        debugLog('Попытка через FAPI...');
        
        // Создаем промис для работы с FAPI
        return new Promise((resolve) => {
            // Проверяем наличие FAPI
            if (window.fapi) {
                window.fapi('users.getInfo', {
                    uids: params.get('vk_ok_user_id') || params.get('vk_user_id'),
                    fields: 'first_name,last_name,pic_2,pic_3'
                }, function(response) {
                    if (response && response.length > 0) {
                        resolve(response[0]);
                    } else {
                        resolve(null);
                    }
                });
            } else {
                resolve(null);
            }
        });
    } catch (error) {
        debugLog('Ошибка FAPI: ' + error.message);
        return null;
    }
}

// Основная функция получения данных пользователя
async function getUserData() {
    debugLog('Начало получения данных пользователя...');
    
    const params = new URLSearchParams(window.location.search);
    const okUserId = params.get('vk_ok_user_id') || params.get('vk_user_id');
    const userName = params.get('user_name');
    
    // Сначала пробуем VK Bridge
    let userData = await getUserInfoViaVKBridge();
    
    // Если не получилось, пробуем FAPI
    if (!userData) {
        userData = await getUserInfoViaFAPI();
    }
    
    // Если все еще нет данных, используем параметры из URL
    if (!userData && userName) {
        debugLog('Используем данные из параметров URL');
        const nameParts = decodeURIComponent(userName).split(' ');
        userData = {
            first_name: nameParts[0] || 'Пользователь',
            last_name: nameParts[1] || 'OK',
            pic_2: null,
            pic_3: null
        };
    }
    
    // Если совсем нет данных
    if (!userData) {
        debugLog('Не удалось получить данные пользователя');
        userData = {
            first_name: 'Гость',
            last_name: 'OK',
            pic_2: null,
            pic_3: null
        };
    }
    
    return userData;
}

// Функция для отображения данных пользователя
function displayUserInfo(user) {
    if (!user) return;
    
    const fullName = `${user.first_name} ${user.last_name}`;
    document.getElementById('userName').textContent = fullName;
    debugLog(`Пользователь: ${fullName}`);
    
    // Аватар
    const avatarImg = document.getElementById('userAvatar');
    const placeholder = document.getElementById('avatarPlaceholder');
    
    // Пробуем разные источники фото
    const avatarUrl = user.pic_3 || user.pic_2 || user.photo_200;
    
    if (avatarUrl) {
        avatarImg.src = avatarUrl;
        avatarImg.onload = function() {
            avatarImg.style.display = 'block';
            placeholder.style.display = 'none';
            debugLog('Аватар загружен: ' + avatarUrl);
        };
        avatarImg.onerror = function() {
            debugLog('Ошибка загрузки аватара');
            placeholder.textContent = user.first_name[0] + user.last_name[0];
            placeholder.style.display = 'flex';
            avatarImg.style.display = 'none';
        };
    } else {
        placeholder.textContent = user.first_name[0] + user.last_name[0];
        placeholder.style.display = 'flex';
        avatarImg.style.display = 'none';
        debugLog('Аватар не найден, используем инициалы');
    }
}

// Функция для тестирования OK API
function testOKAPI() {
    debugLog('Тестирование OK API...');
    
    // Способ 1: Проверяем глобальный OK объект
    if (window.OK && window.OK.Api && typeof window.OK.Api.call === 'function') {
        debugLog('Способ 1: OK.Api.call доступен');
        
        window.OK.Api.call({
            method: 'users.getLoggedInUser',
            callback: function(response) {
                debugLog('OK.Api.call response: ' + JSON.stringify(response));
            }
        });
        return true;
    }
    
    // Способ 2: Проверяем OKSDK
    if (window.OKSDK && typeof window.OKSDK.API === 'function') {
        debugLog('Способ 2: OKSDK.API доступен');
        
        window.OKSDK.API({
            method: 'users.getLoggedInUser',
            callback: function(response) {
                debugLog('OKSDK.API response: ' + JSON.stringify(response));
            }
        });
        return true;
    }
    
    // Способ 3: Пробуем через FAPI
    if (window.fapi) {
        debugLog('Способ 3: FAPI доступен');
        
        window.fapi('users.getLoggedInUser', {}, function(response) {
            debugLog('FAPI response: ' + JSON.stringify(response));
        });
        return true;
    }
    
    debugLog('Ни один способ не доступен');
    return false;
}

// Ловец случайных сообщений
function catchRandomMessage() {
    const messages = [
        "Привет! Как дела?",
        "Сегодня отличный день!",
        "Не забудь улыбнуться :)",
        "Вместе мы можем больше!",
        "Удачи тебе в делах!"
    ];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById("messageBox").textContent = msg;
}

// Инициализация при загрузке
document.addEventListener("DOMContentLoaded", async function() {
    // Событие кнопки
    document.getElementById("randomMessageBtn").addEventListener("click", catchRandomMessage);
    
    debugLog('Приложение загружено');
    debugLog('User ID из логов: 588280768056');
    
    // Получаем данные пользователя
    const userData = await getUserData();
    
    // Отображаем данные
    displayUserInfo(userData);
    
    // Тестируем API через 2 секунды
    setTimeout(testOKAPI, 2000);
});

// Отслеживаем сообщения от родительского окна
window.addEventListener('message', function(event) {
    if (event.origin.includes('ok.ru')) {
        debugLog('Сообщение от ok.ru: ' + JSON.stringify(event.data).substring(0, 100));
    }
});
</script>
</body>
</html>
