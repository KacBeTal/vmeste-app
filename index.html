<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–ú–µ—Å—Ç–µ üåä | –û–∫–µ–∞–Ω –ø–æ—Å–ª–∞–Ω–∏–π –∏–∑ OK.ru</title>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ---- –°—Ç–∏–ª–∏ –∫–∞–∫ –≤ —Ç–≤–æ—ë–º —à–∞–±–ª–æ–Ω–µ ---- */
* {margin:0;padding:0;box-sizing:border-box;}
:root {
    --primary:#4A90E2;
    --secondary:#50E3C2;
    --dark:#1A1A2E;
    --light:#F8F9FA;
    --accent:#FF6B8B;
    --ok-orange:#EE8C3A;
}
body {
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
    background:linear-gradient(135deg,#0F2027,#203A43,#2C5364);
    color:var(--light);min-height:100vh;padding:20px;line-height:1.6;
}
.loading{text-align:center;padding:50px;font-size:18px;}
.loader{border:4px solid rgba(255,255,255,0.1);border-top:4px solid var(--ok-orange);
border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.app-container{max-width:1200px;margin:0 auto;display:none;}
/* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑ —Ç–≤–æ–µ–≥–æ —à–∞–±–ª–æ–Ω–∞ */
</style>
</head>
<body>
<div id="loading" class="loading">
    <div class="loader"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –í–ú–µ—Å—Ç–µ...</p>
    <p id="loading-status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OK.ru...</p>
</div>

<div class="app-container" id="app-container">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üåä</div>
            <h1>–í–ú–µ—Å—Ç–µ</h1>
        </div>
        <div class="status" id="connection-status">
            <div class="status-dot"></div>
            <span>OK.ru</span>
        </div>
    </header>

    <main class="main-layout">
        <!-- Left: Profile -->
        <aside class="profile-card">
            <div class="profile-header" id="profile-header">
                <img src="" alt="Avatar" class="avatar" id="user-avatar">
                <div class="profile-info">
                    <h3 id="user-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
                    <div class="location" id="user-location">üìç OK.ru</div>
                    <div class="status">
                        <div class="status-dot"></div>
                        <span id="user-status">online</span>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="sent-count">0</div>
                    <div class="stat-label">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="caught-count">0</div>
                    <div class="stat-label">–ü–æ–π–º–∞–Ω–æ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="likes-count">0</div>
                    <div class="stat-label">–õ–∞–π–∫–æ–≤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="days-count">1</div>
                    <div class="stat-label">–î–Ω–µ–π –≤ OK</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="refreshProfile()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="showAbout()">‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
            </div>
        </aside>

        <!-- Center: Ocean -->
        <section class="ocean-section">
            <h2 class="ocean-title"><span>üåä –û–∫–µ–∞–Ω –ø–æ—Å–ª–∞–Ω–∏–π –∏–∑ OK.ru</span></h2>
            <div style="margin-bottom:20px;text-align:center;">
                <div class="ok-badge">
                    <span>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π OK.ru –æ–Ω–ª–∞–π–Ω: </span>
                    <span id="online-count">0</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showSendMessage()">‚úçÔ∏è –ë—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–∞–Ω–∏–µ</button>
                <button class="btn btn-primary" onclick="catchRandomMessage()">üé£ –ü–æ–π–º–∞—Ç—å –ø–æ—Å–ª–∞–Ω–∏–µ</button>
            </div>
            <div id="message-display" style="margin-top:30px;">
                <div class="message-bubble">
                    <div class="message-content">
                        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –∏–∑ OK.ru! –ë—Ä–æ—Å—å—Ç–µ —Å–≤–æ—ë –ø–µ—Ä–≤–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ –≤ –æ–∫–µ–∞–Ω –∏–ª–∏ –ø–æ–π–º–∞–π—Ç–µ —á—É–∂–æ–µ."
                    </div>
                    <div class="message-meta">
                        <span>üí¨ OK.ru</span>
                        <span>–¢–æ–ª—å–∫–æ —á—Ç–æ</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Right: Info -->
        <aside class="info-panel">
            <h3 class="info-title">üìä –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
            <p style="margin-bottom:15px;"><strong>"–í–ú–µ—Å—Ç–µ"</strong> ‚Äî —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π OK.ru.</p>
        </aside>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="sendMessageModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:var(--dark);padding:30px;border-radius:20px;width:90%;max-width:500px;border:2px solid var(--ok-orange);">
        <h3 style="margin-bottom:20px;color:var(--ok-orange);">‚úçÔ∏è –ë—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–∞–Ω–∏–µ –≤ –æ–∫–µ–∞–Ω</h3>
        <textarea id="messageInput" placeholder="–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º OK.ru?" style="width:100%;height:150px;padding:15px;border-radius:12px;background:rgba(255,255,255,0.05);color:white;border:1px solid rgba(255,255,255,0.2);font-size:16px;resize:vertical;"></textarea>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button onclick="sendMessage()" class="btn btn-primary" style="flex:1;">üåä –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="hideModal('sendMessageModal')" class="btn btn-secondary" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>

<script>
const SUPABASE_URL = 'https://pyhatmplhbogwufatdga.supabase.co';
const SUPABASE_KEY = 'sb_publishable_rEZH-AdtzcBxBGeEA1hthQ_Ev3YtQ6d';

// üëá —Å–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç Realtime
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = { ok_id:null, full_name:'', avatar_url:'', location:'–û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏' };

// --- –£—Ç–∏–ª–∏—Ç—ã ---
function updateLoadingStatus(msg){document.getElementById('loading-status').textContent=msg;}
function showApp(){document.getElementById('loading').style.display='none';document.getElementById('app-container').style.display='block';}
function showNotification(msg,type='success'){const n=document.createElement('div');n.className='notification';n.style.background=type==='ok'?'#EE8C3A':type==='error'?'#FF6B8B':type==='warning'?'#FFA500':'#50E3C2';n.textContent=msg;document.body.appendChild(n);setTimeout(()=>{n.remove()},3000);}

function getOKAvatarUrl(userId,firstName='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',lastName='OK'){return `https://ui-avatars.com/api/?name=${encodeURIComponent(firstName+' '+lastName)}&background=EE8C3A&color=fff&size=200`;}

// --- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
function getOKUserData(){
    const urlParams=new URLSearchParams(window.location.search);
    const params={};for(const [k,v] of urlParams.entries()) params[k]=v;
    if(params['vk_client']!=='ok'||params['vk_is_app_user']!=='true') return null;
    const okUserId=params['vk_ok_user_id']; const vkUserId=params['vk_user_id'];
    if(!okUserId && !vkUserId) return null;
    return { ok_id: okUserId, vk_user_id: vkUserId, first_name:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', last_name:'OK.ru', full_name:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å OK.ru', avatar_url:getOKAvatarUrl(okUserId), location:'–û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏' };
}

// --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
function updateUserInterface(user){
    currentUser=user;
    document.getElementById('user-name').textContent=user.full_name;
    document.getElementById('user-avatar').src=user.avatar_url;
    document.getElementById('user-location').textContent='üìç '+(user.location||'–û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏');
    document.getElementById('connection-status').innerHTML=`<div class="status-dot" style="background:#EE8C3A"></div><span>–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ OK.ru</span>`;
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø–æ–¥–ø–∏—Å–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ---
async function loadOceanMessages(){
    const { data:errorData, error } = await db.from('messages').select('*').order('created_at',{ascending:false}).limit(3);
    if(error) return console.error(error);
    const display=document.getElementById('message-display');
    display.innerHTML='';
    if(errorData) errorData.forEach(msg=>showMessageInOcean(msg,false));

    // –ü–æ–¥–ø–∏—Å–∫–∞ Realtime
    db.channel('messages_channel')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, payload=>{
          if(payload.eventType==='INSERT') showMessageInOcean(payload.new,true);
      })
      .subscribe();
}

function showMessageInOcean(message,isCaught=false){
    const display=document.getElementById('message-display');
    const time=new Date(message.created_at).toLocaleString('ru-RU',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'});
    const html=`<div class="message-bubble"><div class="message-content">"${message.content}"</div><div class="message-meta"><span>${isCaught?'üé£ –ü–æ–π–º–∞–Ω–æ –∏–∑ OK.ru':'üåä –í –æ–∫–µ–∞–Ω–µ OK.ru'}</span><span>${time}</span></div></div>`;
    display.innerHTML=html+display.innerHTML;
    const bubbles=display.querySelectorAll('.message-bubble'); if(bubbles.length>5)bubbles[bubbles.length-1].remove();
}

// --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
async function sendMessage(){
    const text=document.getElementById('messageInput').value.trim();
    if(!text){showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–∞–Ω–∏—è','warning');return;}
    const messageData={content:text,sender_ok_id:currentUser.ok_id,sender_name:currentUser.full_name,sender_avatar:currentUser.avatar_url,is_anonymous:true,created_at:new Date().toISOString()};
    const { data,error } = await db.from('messages').insert(messageData).select().single();
    if(error){showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','error');console.error(error);return;}
    document.getElementById('messageInput').value='';
    hideModal('sendMessageModal');
    showNotification('‚úÖ –ü–æ—Å–ª–∞–Ω–∏–µ –±—Ä–æ—à–µ–Ω–æ –≤ –æ–∫–µ–∞–Ω!','success');
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
function showSendMessage(){document.getElementById('sendMessageModal').style.display='flex';document.getElementById('messageInput').focus();}
function hideModal(id){document.getElementById(id).style.display='none';}
function showAbout(){showNotification('üåä –í–ú–µ—Å—Ç–µ - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è OK.ru','ok');}
function refreshProfile(){showNotification('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω','success');}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
document.addEventListener('DOMContentLoaded',async ()=>{
    updateLoadingStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OK.ru...');
    const user=getOKUserData();
    if(!user){updateLoadingStatus('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');return;}
    updateUserInterface(user);
    await loadOceanMessages();
    showApp();
});
</script>
</body>
</html>
