<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–ú–µ—Å—Ç–µ üåä | OK.ru</title>

<!-- OK SDK -->
<script src="https://api.ok.ru/js/fapi5.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
body {
    background: linear-gradient(135deg,#0F2027,#203A43,#2C5364);
    color:#fff;
    font-family:system-ui;
    padding:20px;
}
.loading{text-align:center;padding:50px}
.loader{border:4px solid rgba(255,255,255,.1);border-top:4px solid #EE8C3A;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{to{transform:rotate(360deg)}}
#error{color:#ff6b6b;text-align:center;display:none}
#app{display:none}
.avatar{width:70px;height:70px;border-radius:50%;border:3px solid #EE8C3A;object-fit:cover}
</style>
</head>

<body>

<div id="loading" class="loading">
    <div class="loader"></div>
    <p id="loading-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OK.ru‚Ä¶</p>
</div>

<div id="error"></div>

<div id="app">
    <h2 id="user-name"></h2>
    <img id="user-avatar" class="avatar">
    <p id="user-location"></p>
</div>

<script>
/* ================= –ù–ê–°–¢–†–û–ô–ö–ò ================= */
const OK_APP_ID = '–¢–í–û–ô_APP_ID';
const OK_APP_KEY = '–¢–í–û–ô_PUBLIC_APP_KEY';

const SUPABASE_URL = 'https://pyhatmplhbogwufatdga.supabase.co';
const SUPABASE_KEY = 'sb_publishable_rEZH-AdtzcBxBGeEA1hthQ_Ev3YtQ6d';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= –£–¢–ò–õ–ò–¢–´ ================= */
function setLoading(text){
    document.getElementById('loading-text').textContent = text;
}
function showError(text){
    document.getElementById('loading').style.display='none';
    const e=document.getElementById('error');
    e.textContent=text;
    e.style.display='block';
}

/* ================= –ü–†–û–í–ï–†–ö–ê OK ================= */
function checkOKContext(){
    const params=new URLSearchParams(location.search);
    if(params.get('vk_client')!=='ok'){
        showError('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∏–∑ OK.ru');
        return false;
    }
    return true;
}

/* ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø OK ================= */
function initOK(){
    if(!window.OK){
        showError('OK SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }

    OK.init({
        app_id: OK_APP_ID,
        app_key: OK_APP_KEY
    });

    loadOKProfile();
}

/* ================= –ü–û–õ–£–ß–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø ================= */
function loadOKProfile(){
    setLoading('–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è OK‚Ä¶');

    OK.api('users.getCurrentUser',{}, async function(profile){

        if(!profile || !profile.uid){
            showError('OK.ru –Ω–µ –≤–µ—Ä–Ω—É–ª –ø—Ä–æ—Ñ–∏–ª—å');
            return;
        }

        if(!profile.first_name || !profile.last_name || !profile.pic_1){
            showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è OK');
            return;
        }

        // UI
        document.getElementById('user-name').textContent =
            profile.first_name+' '+profile.last_name;
        document.getElementById('user-avatar').src = profile.pic_1;
        document.getElementById('user-location').textContent =
            profile.location?.city ? 'üìç '+profile.location.city : '';

        document.getElementById('loading').style.display='none';
        document.getElementById('app').style.display='block';

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        await saveProfile(profile);
    });
}

/* ================= –°–û–•–†–ê–ù–ï–ù–ò–ï ================= */
async function saveProfile(p){
    const {error}=await supabaseClient
        .from('profiles')
        .upsert({
            ok_id:p.uid,
            first_name:p.first_name,
            last_name:p.last_name,
            full_name:p.first_name+' '+p.last_name,
            avatar_url:p.pic_1,
            location:p.location?.city || null,
            is_ok_user:true,
            is_online:true,
            last_seen:new Date().toISOString()
        },{onConflict:'ok_id'});

    if(error){
        console.error(error);
        showError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è');
    }
}

/* ================= –°–¢–ê–†–¢ ================= */
document.addEventListener('DOMContentLoaded',()=>{
    if(!checkOKContext()) return;
    setLoading('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OK‚Ä¶');
    initOK();
});
</script>

</body>
</html>
