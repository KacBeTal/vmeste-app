<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–í–ú–µ—Å—Ç–µ üåä | OK.ru</title>

<!-- VK Bridge -->
<script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
/* ====== –°–¢–ò–õ–ò (–°–û–ö–†–ê–©–ï–ù–û –ë–ï–ó –ü–û–¢–ï–†–ò –í–ò–î–ê) ====== */
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:linear-gradient(135deg,#0F2027,#203A43,#2C5364);
  color:#fff;
}
#loading{
  height:100vh;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
.loader{
  width:40px;height:40px;
  border:4px solid rgba(255,255,255,.2);
  border-top-color:#EE8C3A;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.app{display:none;max-width:1200px;margin:auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center}
.logo{font-size:28px;font-weight:700}
.profile-card,.ocean{
  background:rgba(255,255,255,.05);
  border-radius:20px;
  padding:20px;
}
.avatar{
  width:70px;height:70px;border-radius:50%;
  border:3px solid #EE8C3A;
}
.btn{
  padding:14px;border:none;border-radius:14px;
  cursor:pointer;font-weight:600;
}
.btn-primary{
  background:linear-gradient(45deg,#EE8C3A,#4A90E2);
  color:#fff;
}
.message{
  background:rgba(255,255,255,.1);
  border-radius:16px;
  padding:16px;
  margin-bottom:12px;
}
</style>
</head>

<body>

<div id="loading">
  <div class="loader"></div>
  <p id="loadingText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</p>
</div>

<div class="app" id="app">
  <div class="header">
    <div class="logo">üåä –í–ú–µ—Å—Ç–µ</div>
    <div>OK.ru</div>
  </div>

  <div style="display:grid;grid-template-columns:300px 1fr;gap:20px;margin-top:20px">
    
    <!-- PROFILE -->
    <div class="profile-card">
      <img id="avatar" class="avatar">
      <h3 id="name"></h3>
      <p id="location">OK.ru</p>
      <button class="btn btn-primary" onclick="openSend()">‚úçÔ∏è –ë—Ä–æ—Å–∏—Ç—å –ø–æ—Å–ª–∞–Ω–∏–µ</button>
    </div>

    <!-- OCEAN -->
    <div class="ocean">
      <h2>üåä –û–∫–µ–∞–Ω –ø–æ—Å–ª–∞–Ω–∏–π</h2>
      <div id="messages"></div>
      <button class="btn btn-primary" onclick="catchMessage()">üé£ –ü–æ–π–º–∞—Ç—å –ø–æ—Å–ª–∞–Ω–∏–µ</button>
    </div>

  </div>
</div>

<!-- MODAL -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center">
  <div style="background:#1A1A2E;padding:20px;border-radius:16px;width:90%;max-width:400px">
    <textarea id="text" style="width:100%;height:120px"></textarea>
    <button class="btn btn-primary" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = 'https://pyhatmplhbogwufatdga.supabase.co';
const SUPABASE_KEY = 'sb_publishable_rEZH-AdtzcBxBGeEA1hthQ_Ev3YtQ6d';

const db = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);


let currentUser = null;

/* ===== INIT ===== */
async function init(){
  await vkBridge.send('VKWebAppInit');

  const user = await vkBridge.send('VKWebAppGetUserInfo');

  currentUser = {
    ok_id: user.id.toString(),
    first_name: user.first_name,
    last_name: user.last_name,
    full_name: user.first_name + ' ' + user.last_name,
    avatar_url: user.photo_100,
    location: '–û–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∏'
  };

  document.getElementById('name').textContent = currentUser.full_name;
  document.getElementById('avatar').src = currentUser.avatar_url;

  await supabase.from('profiles').upsert(currentUser);

  await loadMessages();

  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
}

/* ===== MESSAGES ===== */
async function loadMessages(){
  const { data } = await supabase
    .from('messages')
    .select('*')
    .order('created_at',{ascending:false})
    .limit(5);

  const box = document.getElementById('messages');
  box.innerHTML = '';

  data.forEach(m=>{
    box.innerHTML += `
      <div class="message">
        "${m.content}"
        <div style="opacity:.7;font-size:12px">${new Date(m.created_at).toLocaleString()}</div>
      </div>`;
  });
}

function openSend(){
  document.getElementById('modal').style.display='flex';
}

async function sendMessage(){
  const text = document.getElementById('text').value.trim();
  if(!text) return;

  await supabase.from('messages').insert({
    content:text,
    sender_ok_id:currentUser.ok_id,
    sender_name:currentUser.full_name,
    sender_avatar:currentUser.avatar_url
  });

  document.getElementById('modal').style.display='none';
  document.getElementById('text').value='';
  loadMessages();
}

async function catchMessage(){
  await loadMessages();
}

/* ===== START ===== */
document.addEventListener('DOMContentLoaded',init);
</script>

</body>
</html>
