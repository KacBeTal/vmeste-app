<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВМесте Mini App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .user-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-card img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #0078ff;
        }
        .user-card h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #0078ff;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
        }
        button:hover {
            background-color: #005bb5;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .message-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        .error {
            color: #e74c3c;
            background: #fee;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .info {
            color: #3498db;
            background: #e6f4ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>

<div class="user-card">
    <img id="userAvatar" src="https://via.placeholder.com/80" alt="Avatar">
    <h2 id="userName">Загрузка...</h2>
</div>

<div class="message-box" id="messageBox">
    Добро пожаловать в приложение!
</div>

<div id="statusArea"></div>

<button id="randomMessageBtn">Случайное сообщение</button>

<script>
const YOUR_OK_APP_ID = 512004483266;

// Функция для отображения статуса
function showStatus(message, type = 'info') {
    const statusArea = document.getElementById('statusArea');
    statusArea.innerHTML = `<div class="${type}">${message}</div>`;
}

// Функция инициализации через VK Bridge (поскольку вы используете VK Mini Apps)
function initVKApp() {
    showStatus('Инициализация приложения...');
    
    // Проверяем наличие VK Bridge
    if (typeof vkBridge !== 'undefined') {
        vkBridge.send("VKWebAppInit", {});
        
        // Получаем информацию о пользователе
        vkBridge.send("VKWebAppGetUserInfo", {})
            .then(data => {
                if (data.user) {
                    document.getElementById('userName').textContent = 
                        `${data.user.first_name} ${data.user.last_name}`;
                    if (data.user.photo_200) {
                        document.getElementById('userAvatar').src = data.user.photo_200;
                    }
                    showStatus('Пользователь загружен успешно');
                }
            })
            .catch(error => {
                console.error('Ошибка получения пользователя:', error);
                showStatus('Не удалось получить данные пользователя', 'error');
            });
    } else {
        // Fallback на использование параметров из URL
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get('user_name');
        const userId = urlParams.get('vk_user_id');
        
        if (userName) {
            document.getElementById('userName').textContent = decodeURIComponent(userName);
        }
        
        // Пробуем использовать OK API напрямую
        tryInitOKAPI();
    }
}

// Функция для попытки инициализации OK API
function tryInitOKAPI() {
    // Проверяем наличие OKSDK
    if (typeof OKSDK === 'undefined') {
        // Пытаемся загрузить SDK динамически
        const script = document.createElement('script');
        script.src = 'https://connect.ok.ru/connect.js';
        script.onload = function() {
            if (typeof OKSDK !== 'undefined') {
                OKSDK.init({
                    appId: YOUR_OK_APP_ID,
                    appKey: '',
                    onSuccess: function() {
                        console.log('OKSDK инициализирован');
                        getOKUserInfo();
                    },
                    onFail: function(error) {
                        console.error('Ошибка OKSDK:', error);
                        showStatus('Не удалось подключиться к OK.ru', 'error');
                    }
                });
            }
        };
        script.onerror = function() {
            showStatus('Не удалось загрузить OK SDK', 'error');
        };
        document.head.appendChild(script);
    } else {
        // SDK уже загружен
        OKSDK.init({
            appId: YOUR_OK_APP_ID,
            appKey: '',
            onSuccess: getOKUserInfo,
            onFail: function(error) {
                console.error('Ошибка OKSDK:', error);
            }
        });
    }
}

// Получение информации о пользователе OK.ru
function getOKUserInfo() {
    OKSDK.API({
        method: 'users.getLoggedInUser',
        async: true,
        callback: function(response) {
            if (response && response.uid) {
                // Получаем детальную информацию о пользователе
                OKSDK.API({
                    method: 'users.getInfo',
                    uids: response.uid,
                    fields: 'first_name,last_name,pic_2',
                    async: true,
                    callback: function(userResponse) {
                        if (userResponse && userResponse.length > 0) {
                            const user = userResponse[0];
                            document.getElementById('userName').textContent = 
                                `${user.first_name} ${user.last_name}`;
                            if (user.pic_2) {
                                document.getElementById('userAvatar').src = user.pic_2;
                            }
                            showStatus('Данные OK.ru загружены');
                        }
                    }
                });
            }
        }
    });
}

// Ловец случайных сообщений
function catchRandomMessage() {
    const messages = [
        "Привет! Как дела?",
        "Сегодня отличный день!",
        "Не забудь улыбнуться :)",
        "Вместе мы можем больше!",
        "Удачи тебе в делах!"
    ];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById("messageBox").textContent = msg;
}

// Инициализация при загрузке
document.addEventListener("DOMContentLoaded", function() {
    // Событие кнопки
    document.getElementById("randomMessageBtn").addEventListener("click", catchRandomMessage);
    
    // Начинаем инициализацию
    initVKApp();
});
</script>
</body>
</html>
