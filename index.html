<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВМесте Mini App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .user-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-card img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #ee8208;
        }
        .avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ee8208 0%, #f6b044 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ee8208;
        }
        .user-card h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #ee8208;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
        }
        button:hover {
            background-color: #d67307;
        }
        .message-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            max-width: 400px;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        .loading {
            background: #e6f4ff;
            color: #3498db;
        }
        .success {
            background: #d5f4e6;
            color: #27ae60;
        }
        .error {
            background: #fee;
            color: #e74c3c;
        }
    </style>
</head>
<body>

<div class="user-card">
    <div class="avatar-placeholder" id="avatarPlaceholder">OK</div>
    <img id="userAvatar" style="display: none;" alt="Avatar">
    <h2 id="userName">Загрузка...</h2>
</div>

<div class="message-box" id="messageBox">
    Добро пожаловать в приложение ВМесте!
</div>

<div id="statusArea" class="status loading">
    Инициализация приложения...
</div>

<button id="randomMessageBtn">Случайное сообщение</button>

<script>
// ID вашего приложения OK
const OK_APP_ID = 512004483266;

// Функция для отображения статуса
function showStatus(message, type = 'loading') {
    const statusArea = document.getElementById('statusArea');
    statusArea.textContent = message;
    statusArea.className = `status ${type}`;
}

// Функция для получения параметров из URL
function getUrlParams() {
    const params = {};
    const queryString = window.location.search.substring(1);
    const pairs = queryString.split('&');
    
    for (const pair of pairs) {
        const [key, value] = pair.split('=');
        if (key && value) {
            params[key] = decodeURIComponent(value);
        }
    }
    
    return params;
}

// Функция для получения информации о пользователе через OK API
async function getOKUserInfo() {
    showStatus('Получение данных пользователя из OK...', 'loading');
    
    try {
        // Параметры из URL
        const params = getUrlParams();
        const okUserId = params.vk_ok_user_id || params.vk_user_id;
        
        console.log('Параметры URL:', params);
        console.log('OK User ID:', okUserId);
        
        if (!okUserId) {
            throw new Error('ID пользователя не найден в параметрах');
        }
        
        // Проверяем наличие OK SDK
        if (typeof window.OK === 'undefined' || typeof window.OKSDK === 'undefined') {
            throw new Error('OK SDK не загружен');
        }
        
        // Получаем информацию о пользователе
        return new Promise((resolve, reject) => {
            if (window.OK && window.OK.Api) {
                // Для глобального OK объекта
                window.OK.Api.call({
                    method: 'users.getInfo',
                    uids: okUserId,
                    fields: 'first_name,last_name,pic_2,pic_3',
                    callback: function(response) {
                        if (response && response.length > 0 && response[0]) {
                            resolve(response[0]);
                        } else {
                            reject(new Error('Не удалось получить данные пользователя'));
                        }
                    }
                });
            } else if (window.OKSDK) {
                // Для OKSDK объекта
                OKSDK.API({
                    method: 'users.getInfo',
                    uids: okUserId,
                    fields: 'first_name,last_name,pic_2,pic_3',
                    callback: function(response) {
                        if (response && response.length > 0 && response[0]) {
                            resolve(response[0]);
                        } else {
                            reject(new Error('Не удалось получить данные пользователя через OKSDK'));
                        }
                    }
                });
            } else {
                reject(new Error('API OK не доступен'));
            }
        });
        
    } catch (error) {
        console.error('Ошибка при получении данных пользователя:', error);
        throw error;
    }
}

// Функция для отображения данных пользователя
function displayUserInfo(user) {
    if (!user) {
        showStatus('Данные пользователя не получены', 'error');
        return;
    }
    
    // Имя и фамилия
    const fullName = `${user.first_name} ${user.last_name}`;
    document.getElementById('userName').textContent = fullName;
    console.log('Получены данные пользователя:', user);
    
    // Аватар
    const avatarImg = document.getElementById('userAvatar');
    const placeholder = document.getElementById('avatarPlaceholder');
    
    // Используем лучшее доступное фото
    const avatarUrl = user.pic_3 || user.pic_2;
    
    if (avatarUrl) {
        avatarImg.src = avatarUrl;
        avatarImg.onload = function() {
            avatarImg.style.display = 'block';
            placeholder.style.display = 'none';
            showStatus(`Добро пожаловать, ${user.first_name}!`, 'success');
        };
        avatarImg.onerror = function() {
            // Если фото не загрузилось, показываем placeholder
            placeholder.textContent = user.first_name[0] + user.last_name[0];
            placeholder.style.display = 'flex';
            avatarImg.style.display = 'none';
            showStatus(`Добро пожаловать, ${user.first_name}! (аватар не загружен)`, 'success');
        };
    } else {
        // Если нет фото, показываем инициалы в placeholder
        placeholder.textContent = user.first_name[0] + user.last_name[0];
        placeholder.style.display = 'flex';
        avatarImg.style.display = 'none';
        showStatus(`Добро пожаловать, ${user.first_name}!`, 'success');
    }
}

// Функция инициализации OK SDK
function initOKSDK() {
    return new Promise((resolve, reject) => {
        // Проверяем, уже ли загружен SDK
        if (typeof window.OK !== 'undefined' || typeof window.OKSDK !== 'undefined') {
            console.log('OK SDK уже загружен');
            resolve();
            return;
        }
        
        showStatus('Загрузка OK SDK...', 'loading');
        
        // Загружаем OK SDK
        const script = document.createElement('script');
        script.src = 'https://connect.ok.ru/connect.js';
        
        script.onload = function() {
            console.log('OK SDK загружен успешно');
            
            // Даем время на инициализацию
            setTimeout(() => {
                // Пробуем разные варианты инициализации
                if (typeof window.okAsyncInit === 'function') {
                    window.okAsyncInit();
                }
                
                if (typeof window.OKSDK !== 'undefined') {
                    // Инициализируем OKSDK
                    try {
                        OKSDK.init({
                            appId: OK_APP_ID,
                            appKey: '',
                            onSuccess: function() {
                                console.log('OKSDK инициализирован');
                                resolve();
                            },
                            onFail: function(error) {
                                console.error('Ошибка инициализации OKSDK:', error);
                                resolve(); // Все равно разрешаем, может другие методы сработают
                            }
                        });
                    } catch (e) {
                        console.log('OKSDK.init вызвал ошибку, но продолжаем:', e);
                        resolve();
                    }
                } else {
                    resolve();
                }
            }, 500);
        };
        
        script.onerror = function() {
            console.error('Не удалось загрузить OK SDK');
            reject(new Error('Не удалось загрузить OK SDK'));
        };
        
        document.head.appendChild(script);
    });
}

// Основная функция инициализации
async function initApp() {
    try {
        // Получаем параметры из URL
        const params = getUrlParams();
        console.log('Все параметры URL:', params);
        
        // Проверяем, что мы в OK
        if (params.vk_platform !== 'desktop_web_ok') {
            showStatus('Приложение работает в режиме OK.ru', 'error');
            return;
        }
        
        // Инициализируем OK SDK
        await initOKSDK();
        
        // Получаем данные пользователя
        const user = await getOKUserInfo();
        
        // Отображаем данные пользователя
        displayUserInfo(user);
        
    } catch (error) {
        console.error('Ошибка инициализации:', error);
        
        // Fallback: используем данные из параметров URL
        const params = getUrlParams();
        const userName = params.user_name;
        
        if (userName) {
            document.getElementById('userName').textContent = decodeURIComponent(userName);
            const placeholder = document.getElementById('avatarPlaceholder');
            const nameParts = decodeURIComponent(userName).split(' ');
            if (nameParts.length >= 2) {
                placeholder.textContent = nameParts[0][0] + nameParts[1][0];
            }
            showStatus('Используются данные из параметров', 'success');
        } else {
            showStatus('Не удалось получить данные пользователя', 'error');
        }
    }
}

// Ловец случайных сообщений
function catchRandomMessage() {
    const messages = [
        "Привет! Как дела?",
        "Сегодня отличный день!",
        "Не забудь улыбнуться :)",
        "Вместе мы можем больше!",
        "Удачи тебе в делах!",
        "Рады видеть вас в OK!",
        "Всего самого наилучшего!",
        "Хорошего настроения!",
        "Успехов во всех начинаниях!",
        "Пусть день будет продуктивным!"
    ];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById("messageBox").textContent = msg;
}

// Инициализация при загрузке
document.addEventListener("DOMContentLoaded", function() {
    // Событие кнопки
    document.getElementById("randomMessageBtn").addEventListener("click", catchRandomMessage);
    
    // Начинаем инициализацию
    setTimeout(initApp, 100);
});
</script>
</body>
</html>
