<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВМесте Mini App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .user-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-card img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #ee8208;
        }
        .avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            border: 2px dashed #ccc;
        }
        .user-card h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #ee8208;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
        }
        button:hover {
            background-color: #d67307;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .message-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            max-width: 400px;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            background: #e6f4ff;
            color: #3498db;
        }
        .error {
            background: #fee;
            color: #e74c3c;
        }
        .success {
            background: #d5f4e6;
            color: #27ae60;
        }
    </style>
</head>
<body>

<div class="user-card">
    <div class="avatar-placeholder" id="avatarPlaceholder">Нет фото</div>
    <img id="userAvatar" style="display: none;" alt="Avatar">
    <h2 id="userName">Загрузка...</h2>
</div>

<div class="message-box" id="messageBox">
    Загрузка данных...
</div>

<div id="statusArea" class="status">
    Инициализация приложения...
</div>

<button id="randomMessageBtn" disabled>Случайное сообщение</button>

<script>
// Функция для отображения статуса
function showStatus(message, type = 'status') {
    const statusArea = document.getElementById('statusArea');
    statusArea.textContent = message;
    statusArea.className = `status ${type}`;
}

// Функция для разбора параметров URL
function parseUrlParams() {
    const params = {};
    const queryString = window.location.search.substring(1);
    const pairs = queryString.split('&');
    
    for (const pair of pairs) {
        const [key, value] = pair.split('=');
        if (key && value) {
            try {
                params[key] = decodeURIComponent(value.replace(/\+/g, ' '));
            } catch (e) {
                params[key] = value;
            }
        }
    }
    
    return params;
}

// Основная функция получения данных
async function getUserData() {
    showStatus('Получение данных пользователя...');
    
    try {
        // Получаем параметры из URL
        const params = parseUrlParams();
        console.log('Параметры URL:', params);
        
        // Пробуем получить данные через VK Bridge (если есть)
        if (typeof vkBridge !== 'undefined') {
            showStatus('Используем VK Bridge...');
            
            try {
                // Инициализируем VK Bridge
                await vkBridge.send('VKWebAppInit', {});
                
                // Получаем информацию о пользователе
                const userInfo = await vkBridge.send('VKWebAppGetUserInfo', {});
                
                if (userInfo && userInfo.user) {
                    return {
                        first_name: userInfo.user.first_name,
                        last_name: userInfo.user.last_name,
                        photo: userInfo.user.photo_200,
                        source: 'vk_bridge'
                    };
                }
            } catch (error) {
                console.warn('VK Bridge не сработал:', error);
            }
        }
        
        // Пробуем получить данные через OK API (если есть)
        if (typeof window.OK !== 'undefined' && window.OK.Api && typeof window.OK.Api.call === 'function') {
            showStatus('Используем OK API...');
            
            return new Promise((resolve) => {
                window.OK.Api.call({
                    method: 'users.getLoggedInUser',
                    callback: function(response) {
                        if (response && response.uid) {
                            window.OK.Api.call({
                                method: 'users.getInfo',
                                uids: response.uid,
                                fields: 'first_name,last_name,pic_2,pic_3',
                                callback: function(userResponse) {
                                    if (userResponse && userResponse.length > 0) {
                                        resolve({
                                            first_name: userResponse[0].first_name,
                                            last_name: userResponse[0].last_name,
                                            photo: userResponse[0].pic_3 || userResponse[0].pic_2,
                                            source: 'ok_api'
                                        });
                                    } else {
                                        resolve(null);
                                    }
                                }
                            });
                        } else {
                            resolve(null);
                        }
                    }
                });
            });
        }
        
        // Пробуем получить данные из параметров (если переданы)
        const userName = params.user_name;
        const okUserId = params.vk_ok_user_id || params.vk_user_id;
        
        if (userName) {
            showStatus('Используем данные из параметров URL...');
            const nameParts = userName.split(' ');
            
            return {
                first_name: nameParts[0] || '',
                last_name: nameParts.slice(1).join(' ') || '',
                photo: null,
                source: 'url_params'
            };
        }
        
        // Если ничего не сработало
        return null;
        
    } catch (error) {
        console.error('Ошибка получения данных:', error);
        return null;
    }
}

// Функция отображения данных пользователя
async function displayUserData() {
    const userData = await getUserData();
    const btn = document.getElementById('randomMessageBtn');
    
    if (!userData) {
        document.getElementById('userName').textContent = 'Данные не получены';
        document.getElementById('messageBox').textContent = 'Не удалось загрузить данные пользователя';
        showStatus('Ошибка загрузки данных', 'error');
        btn.disabled = false;
        return;
    }
    
    // Отображаем имя
    const fullName = `${userData.first_name} ${userData.last_name}`.trim();
    if (fullName) {
        document.getElementById('userName').textContent = fullName;
        document.getElementById('messageBox').textContent = `Привет, ${userData.first_name}!`;
    } else {
        document.getElementById('userName').textContent = 'Пользователь';
        document.getElementById('messageBox').textContent = 'Добро пожаловать!';
    }
    
    // Отображаем аватар
    if (userData.photo) {
        const avatarImg = document.getElementById('userAvatar');
        const placeholder = document.getElementById('avatarPlaceholder');
        
        avatarImg.src = userData.photo;
        avatarImg.onload = function() {
            avatarImg.style.display = 'block';
            placeholder.style.display = 'none';
        };
        avatarImg.onerror = function() {
            // Если фото не загрузилось, оставляем placeholder
            avatarImg.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.textContent = 'Ошибка фото';
        };
    }
    
    // Обновляем статус
    const sourceMap = {
        'vk_bridge': 'VK Bridge',
        'ok_api': 'OK API',
        'url_params': 'Параметры URL'
    };
    
    showStatus(`Данные загружены (${sourceMap[userData.source] || 'неизвестно'})`, 'success');
    btn.disabled = false;
}

// Ловец случайных сообщений
function catchRandomMessage() {
    const messages = [
        "Привет! Как дела?",
        "Сегодня отличный день!",
        "Не забудь улыбнуться :)",
        "Вместе мы можем больше!",
        "Удачи тебе в делах!"
    ];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById("messageBox").textContent = msg;
}

// Инициализация при загрузке
document.addEventListener("DOMContentLoaded", function() {
    // Кнопка случайного сообщения
    const btn = document.getElementById('randomMessageBtn');
    btn.addEventListener("click", catchRandomMessage);
    
    // Загружаем данные пользователя
    displayUserData();
    
    // Пробуем обновить данные через 3 секунды (на случай если API еще не загрузился)
    setTimeout(() => {
        if (document.getElementById('userName').textContent === 'Загрузка...') {
            showStatus('Повторная попытка загрузки...');
            displayUserData();
        }
    }, 3000);
});
</script>
</body>
</html>
