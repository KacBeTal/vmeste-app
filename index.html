<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ВМесте Mini App</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .user-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .user-card img {
            border-radius: 50%;
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid #ee8208;
        }
        .avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ee8208 0%, #f6b044 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #ee8208;
        }
        .user-card h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            background-color: #ee8208;
            color: white;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 20px;
        }
        button:hover {
            background-color: #d67307;
        }
        .message-box {
            background: #fff;
            padding: 15px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            max-width: 400px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
        }
        .debug-console {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-width: 600px;
            width: 100%;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="user-card">
    <div class="avatar-placeholder" id="avatarPlaceholder">OK</div>
    <img id="userAvatar" style="display: none;" alt="Avatar">
    <h2 id="userName">Загрузка...</h2>
</div>

<div class="message-box" id="messageBox">
    Добро пожаловать в приложение ВМесте!
</div>

<button id="randomMessageBtn">Случайное сообщение</button>
<button id="testOKBtn" onclick="testOKAPI()">Тест OK API</button>

<div class="debug-console" id="debugConsole">
    Консоль отладки:
</div>

<script>
// Функция для отладки в консоль
function debugLog(message) {
    const consoleDiv = document.getElementById('debugConsole');
    consoleDiv.innerHTML += '\n' + message;
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
    console.log(message);
}

// Получаем параметры из URL правильно
function getUrlParams() {
    const params = {};
    const queryString = window.location.search.substring(1);
    const pairs = queryString.split('&');
    
    for (const pair of pairs) {
        const [key, value] = pair.split('=');
        if (key && value) {
            try {
                params[key] = decodeURIComponent(value.replace(/\+/g, ' '));
            } catch (e) {
                params[key] = value;
            }
        }
    }
    
    return params;
}

// Пробуем получить данные из VK Mini Apps API
async function getVKUserInfo() {
    try {
        debugLog('Проверяем VK Bridge...');
        
        // Если есть vkBridge (стандартный способ для VK Mini Apps)
        if (typeof vkBridge !== 'undefined') {
            debugLog('VK Bridge найден');
            const userInfo = await vkBridge.send('VKWebAppGetUserInfo', {});
            return {
                first_name: userInfo.user.first_name,
                last_name: userInfo.user.last_name,
                photo: userInfo.user.photo_200
            };
        }
        
        // Если есть window.fapi (используется в OK)
        if (typeof window.fapi === 'function') {
            debugLog('FAPI найден');
            return new Promise((resolve) => {
                window.fapi('users.getLoggedInUser', {}, (response) => {
                    if (response && response.uid) {
                        window.fapi('users.getInfo', {
                            uids: response.uid,
                            fields: 'first_name,last_name,pic_2'
                        }, (userResponse) => {
                            if (userResponse && userResponse.length > 0) {
                                resolve({
                                    first_name: userResponse[0].first_name,
                                    last_name: userResponse[0].last_name,
                                    photo: userResponse[0].pic_2
                                });
                            } else {
                                resolve(null);
                            }
                        });
                    } else {
                        resolve(null);
                    }
                });
            });
        }
        
    } catch (error) {
        debugLog('Ошибка при получении данных через API: ' + error.message);
    }
    
    return null;
}

// Тестируем OK API
function testOKAPI() {
    debugLog('\n=== ТЕСТИРОВАНИЕ OK API ===');
    
    // Способ 1: Проверяем глобальный OK объект
    if (window.OK) {
        debugLog('window.OK есть:');
        debugLog('Ключи OK: ' + Object.keys(window.OK).join(', '));
        
        // Пробуем разные методы
        if (window.OK.Api && typeof window.OK.Api.call === 'function') {
            debugLog('OK.Api.call доступен');
            
            window.OK.Api.call({
                method: 'users.getLoggedInUser',
                callback: function(response) {
                    debugLog('OK.Api.call результат: ' + JSON.stringify(response));
                    
                    if (response && response.uid) {
                        window.OK.Api.call({
                            method: 'users.getInfo',
                            uids: response.uid,
                            fields: 'first_name,last_name,pic_2,pic_3',
                            callback: function(userResponse) {
                                debugLog('Данные пользователя: ' + JSON.stringify(userResponse));
                                
                                if (userResponse && userResponse.length > 0) {
                                    const user = userResponse[0];
                                    displayUserInfo({
                                        first_name: user.first_name,
                                        last_name: user.last_name,
                                        photo: user.pic_3 || user.pic_2
                                    });
                                }
                            }
                        });
                    }
                }
            });
        } else {
            debugLog('OK.Api.call НЕ доступен');
        }
        
        // Пробуем другие возможные методы
        if (window.OK.sendBeacon) {
            debugLog('OK.sendBeacon доступен');
        }
        
        if (window.OK.startupData) {
            debugLog('OK.startupData: ' + JSON.stringify(window.OK.startupData));
        }
    } else {
        debugLog('window.OK НЕТ');
    }
    
    // Способ 2: Пробуем прямой запрос к OK API
    debugLog('\n=== ПРЯМОЙ ЗАПРОС К API ===');
    
    // Из логов видим, что API Server: https://api.ok.ru/
    const okUserId = '588280768056'; // Из ваших логов
    
    // Пробуем сделать JSONP запрос (так как CORS может блокировать обычные запросы)
    const callbackName = 'okCallback_' + Date.now();
    const script = document.createElement('script');
    
    window[callbackName] = function(response) {
        debugLog('JSONP ответ: ' + JSON.stringify(response));
        delete window[callbackName];
    };
    
    // Внимание: для реального запроса нужен access_token и правильная подпись
    // Это только демонстрация формата
    script.src = `https://api.ok.ru/fb.do?method=users.getInfo&uids=${okUserId}&fields=first_name,last_name,pic_2&callback=${callbackName}`;
    
    script.onerror = function() {
        debugLog('JSONP запрос не удался (нужен access_token)');
        delete window[callbackName];
    };
    
    document.head.appendChild(script);
    setTimeout(() => {
        if (script.parentNode) {
            script.parentNode.removeChild(script);
        }
    }, 5000);
}

// Основная функция получения данных
async function loadUserData() {
    debugLog('Загрузка данных пользователя...');
    
    // Получаем параметры
    const params = getUrlParams();
    debugLog('Параметры URL: ' + JSON.stringify(params));
    
    // Пробуем получить данные через API
    const apiData = await getVKUserInfo();
    
    if (apiData) {
        debugLog('Данные получены через API');
        displayUserInfo(apiData);
        return;
    }
    
    // Если API не сработал, используем данные из параметров
    debugLog('API не сработал, используем fallback...');
    
    // Из ваших логов видим: user_name: 'Степан Королёв'
    const userName = params.user_name || 'Степан Королёв';
    const okUserId = params.vk_ok_user_id || '588280768056';
    
    debugLog(`Имя из параметров: ${userName}`);
    debugLog(`ID пользователя: ${okUserId}`);
    
    // Разбиваем имя на части
    const nameParts = userName.split(' ');
    const firstName = nameParts[0] || 'Пользователь';
    const lastName = nameParts.slice(1).join(' ') || 'OK';
    
    displayUserInfo({
        first_name: firstName,
        last_name: lastName,
        photo: null
    });
    
    // Пробуем загрузить фото пользователя из OK
    setTimeout(() => {
        loadUserPhoto(okUserId, firstName, lastName);
    }, 1000);
}

// Пробуем загрузить фото пользователя
function loadUserPhoto(userId, firstName, lastName) {
    debugLog(`Попытка загрузить фото для пользователя ${userId}...`);
    
    // Создаем URL для фото пользователя OK
    // Формат: https://avatars.mds.yandex.net/get-ok/...
    // Но точный формат зависит от настроек пользователя
    
    // Пробуем разные возможные форматы
    const photoUrls = [
        `https://i.mycdn.me/getVideoPreview?id=${userId}&type=37&idx=0&tkn=1`,
        `https://i.mycdn.me/image?id=${userId}&type=2&tkn=1`,
        // Добавьте другие возможные форматы
    ];
    
    const avatarImg = document.getElementById('userAvatar');
    const placeholder = document.getElementById('avatarPlaceholder');
    
    let currentIndex = 0;
    
    function tryNextPhoto() {
        if (currentIndex >= photoUrls.length) {
            debugLog('Все варианты фото не загрузились');
            return;
        }
        
        const testImg = new Image();
        testImg.onload = function() {
            debugLog(`Фото загружено с URL: ${photoUrls[currentIndex]}`);
            avatarImg.src = photoUrls[currentIndex];
            avatarImg.style.display = 'block';
            placeholder.style.display = 'none';
        };
        
        testImg.onerror = function() {
            debugLog(`Не удалось загрузить фото из ${photoUrls[currentIndex]}`);
            currentIndex++;
            setTimeout(tryNextPhoto, 500);
        };
        
        testImg.src = photoUrls[currentIndex];
    }
    
    tryNextPhoto();
}

// Функция для отображения данных пользователя
function displayUserInfo(user) {
    if (!user) return;
    
    const fullName = `${user.first_name} ${user.last_name}`;
    document.getElementById('userName').textContent = fullName;
    document.getElementById('messageBox').textContent = `Привет, ${user.first_name}! Рады видеть вас в ВМесте!`;
    
    debugLog(`Отображаем пользователя: ${fullName}`);
    
    // Аватар
    const avatarImg = document.getElementById('userAvatar');
    const placeholder = document.getElementById('avatarPlaceholder');
    
    if (user.photo) {
        avatarImg.src = user.photo;
        avatarImg.onload = function() {
            avatarImg.style.display = 'block';
            placeholder.style.display = 'none';
            debugLog('Аватар загружен');
        };
        avatarImg.onerror = function() {
            debugLog('Ошибка загрузки аватара, показываем инициалы');
            showInitials(user.first_name, user.last_name);
        };
    } else {
        showInitials(user.first_name, user.last_name);
    }
}

// Показать инициалы
function showInitials(firstName, lastName) {
    const placeholder = document.getElementById('avatarPlaceholder');
    const avatarImg = document.getElementById('userAvatar');
    
    const initials = (firstName[0] + lastName[0]).toUpperCase();
    placeholder.textContent = initials;
    placeholder.style.display = 'flex';
    avatarImg.style.display = 'none';
}

// Ловец случайных сообщений
function catchRandomMessage() {
    const messages = [
        "Привет! Как дела?",
        "Сегодня отличный день!",
        "Не забудь улыбнуться :)",
        "Вместе мы можем больше!",
        "Удачи тебе в делах!"
    ];
    const msg = messages[Math.floor(Math.random() * messages.length)];
    document.getElementById("messageBox").textContent = msg;
}

// Инициализация при загрузке
document.addEventListener("DOMContentLoaded", function() {
    // Событие кнопки
    document.getElementById("randomMessageBtn").addEventListener("click", catchRandomMessage);
    
    debugLog('Приложение ВМесте загружено');
    debugLog('Информация из логов:');
    debugLog('- App ID: 512004483266');
    debugLog('- User ID: 588280768056');
    debugLog('- Имя: Степавн Королёв');
    
    // Загружаем данные пользователя
    loadUserData();
});
</script>
</body>
</html>
